### **智能温控摆头风扇系统**

**实验报告**

**课程名称:** Computer & Control
**项目名称:** 全功能智能摆头温控风扇 (16针并口LCD版)

---

### **1. 摘要 (Abstract)**

本报告详细阐述了一个基于Arduino Uno微控制器设计与实现的多功能智能风扇系统。该系统旨在模拟一个现代化的智能家居设备，集成了环境感知、用户交互、多模式控制以及丰富的声光状态反馈。系统通过LM35温度传感器实时监测环境温度，并以此为依据在**自动模式**下智能调节SG90舵机（模拟风扇摆头）的摆动幅度和RGB LED的状态颜色。用户可通过TTP223B电容式触摸传感器无缝切换至**手动模式**，该模式提供三档固定的摆动范围。所有关键信息，如实时温度、运行模式和摆动参数，均通过一块1602并口LCD屏幕进行清晰显示。此外，系统还配备了无源蜂鸣器，用于模式切换的即时反馈和超温条件下的声学警报。

项目开发中的核心挑战是实现一个完全**非阻塞式**的软件架构，以确保舵机平滑运行的同时，触摸传感器能保持高度灵敏。通过采用基于`millis()`的定时任务调度，系统成功地将高频任务（舵机控制、触摸检测）与低频任务（温度采集、屏幕刷新）分离，有效解决了`delay()`函数阻塞带来的响应延迟问题。最终，系统稳定可靠，完全达到了预设的全部设计目标。

---

### **2. 项目目标 (Introduction & Objectives)**

根据CNENGR115课程要求，本次实践评估的核心是设计一个包含至少一个传感器和一个执行器的嵌入式控制系统。为追求设计的**新颖性**与**复杂性**，本项目设定了以下具体目标：

1.  **环境感知:** 使用LM35温度传感器精确测量实时环境温度。
2.  **双模式控制:**
    *   **自动模式:** 系统根据温度高低，自动分级控制风扇的摆动幅度和状态指示。
    *   **手动模式:** 允许用户通过触摸操作，在预设的三档风扇摆动范围中自由选择。
3.  **人机交互界面 (HMI):**
    *   使用1602 LCD屏幕作为信息中心，实时显示温度、模式和系统参数。
    *   使用电容式触摸传感器作为输入设备，实现简洁、现代的控制方式。
4.  **多重状态反馈:**
    *   使用RGB三色LED，以不同颜色（绿、黄、红、蓝）直观表示系统的不同运行状态。
    *   使用无源蜂鸣器，提供操作提示音和超温报警功能。
5.  **执行机构:** 使用SG90舵机模拟风扇的左右摆头动作，以动态方式展示控制效果。
6.  **高效软件架构:** 开发稳定、高响应度的非阻塞式代码，确保所有模块协同工作，互不干扰。

---

### **3. 实验器材与组件 (Materials and Components)**

| 数量 | 组件名称 | 型号/规格 | 主要用途 |
| :--- | :--- | :--- | :--- |
| 1 | 微控制器 | Arduino Uno R3 | 系统主控 |
| 1 | 温度传感器 | LM35 | 测量环境温度 |
| 1 | 舵机 | SG90 | 模拟风扇摆头 |
| 1 | 触摸传感器 | TTP223B 电容式 | 模式切换输入 |
| 1 | 显示模块 | 1602 并口LCD | 显示系统信息 |
| 1 | 电位器 | 10kΩ | 调节LCD对比度 |
| 1 | 状态指示灯 | 共阴极 RGB LED | 多级状态颜色反馈 |
| 1 | 声音模块 | 无源蜂鸣器 | 声音提示与报警 |
| 4 | 电阻 | 220Ω | 为RGB LED和LCD背光限流 |
| 1 | 面包板 | 830孔 | 构建电路 |
| - | 杜邦线 | 若干 | 连接各模块 |

---

### **4. 系统设计 (System Design)**

#### **4.1 硬件设计与连接**

系统以Arduino Uno为核心，连接各个输入（传感器）和输出（执行器、显示）模块。整体电路设计注重引脚的合理分配，特别是将需要PWM（脉冲宽度调制）功能的模块（舵机、RGB LED）连接到Arduino的PWM引脚（带`~`符号）。

**电路连接详单:** (建议在此处附上一张使用Fritzing软件绘制的电路图)

| 组件 (Component) | 引脚 (Pin) | 连接到 Arduino (Connect to) |
| :--- | :--- | :--- |
| **1602 LCD** | RS, E, D4, D5, D6, D7 | D7, D8, D10, D11, D12, D13 |
| | VSS, R/W, K | GND |
| | VDD, A | 5V (A通过220Ω电阻) |
| | VO | 10k电位器中间引脚 |
| **LM35 温度传感器** | Vout | A0 |
| **SG90 舵机** | 信号线 (橙色) | ~9 |
| **TTP223B 触摸传感器** | SIG | D2 |
| **共阴极 RGB LED** | R, G, B | 220Ω电阻 -> ~3, ~5, ~6 |
| **无源蜂鸣器** | + | D4 |

#### **4.2 软件设计**

软件是本项目的核心，其设计的优劣直接决定了系统的性能。

**4.2.1 核心架构：非阻塞式任务调度**

为解决多任务（如平滑摆头和即时触摸响应）之间的冲突，代码采用了基于`millis()`的非阻塞式架构。主循环`loop()`函数被设计成一个快速轮询的调度器，没有任何`delay()`函数会长时间阻塞程序的执行。

*   **高频任务:** 触摸检测 (`check_touch_input`) 和舵机单步移动 (`control_servo_non_blocking`) 在每次`loop()`循环中都会被调用，确保了毫秒级的响应速度。
*   **低频任务:** 温度读取、逻辑判断和LCD屏幕刷新被置于一个定时判断语句块中，每隔1000毫秒（1秒）才执行一次。这大大提高了系统效率，并避免了LCD屏幕不必要的频繁刷新。

**4.2.2 状态机与模式切换**

系统内置一个简单的状态机，通过全局变量`current_mode`来管理。该变量有四个状态：`MODE_AUTO`, `MODE_GEAR_1`, `MODE_GEAR_2`, `MODE_GEAR_3`。触摸传感器作为状态切换的触发器，每次触发都会使状态在0到3之间循环递增，实现了在自动模式与三档手动模式间的无缝切换。

**4.2.3 主要功能函数**

*   `loop()`: 核心调度函数，分离高频和低频任务。
*   `check_touch_input()`: 非阻塞式检测触摸输入，并进行300ms的软件防抖。
*   `control_servo_non_blocking()`: 非阻塞式舵机控制函数。每次被调用时，仅根据预设的时间间隔（15ms）移动一小步，然后立即返回。
*   `update_lcd()`: 统一的屏幕更新函数，将所有信息一次性清晰地显示在LCD上。
*   其他辅助函数: 如`read_temperature()`, `set_led_color()`, `beep()`等，将特定功能封装起来，提高了代码的可读性和复用性。

---

### **5. 实现与结果展示 (Implementation & Results)**

项目硬件搭建完成后，将最终优化版的代码上传至Arduino Uno。系统运行稳定，各项功能均符合设计预期。

*   **开机状态:** 系统启动，LCD显示欢迎信息，蜂鸣器发出提示音，舵机归位至90度中心位置，随后进入默认的**自动模式**。
*   **自动模式测试:**
    *   **常温 (低于26°C):** RGB LED显示**绿色**，舵机以最小范围(±20°)摆动。
    *   **手握传感器升温 (26°C-30°C):** LED变为**黄色**，舵机摆动范围自动增大至中等(±45°)。
    *   **持续加热 (高于30°C):** LED变为**红色**，舵机以最大范围(±70°)摆动，同时蜂鸣器发出**每秒一次的警报音**。
*   **手动模式测试:**
    *   **轻触传感器:** 蜂鸣器"滴"一声，系统进入**手动模式**，LED变为**蓝色**。LCD显示"Gear 1"，舵机按一档(±20°)摆动。
    *   **再次触摸:** 模式切换至"Gear 2"，摆动范围增大至±45°。
    *   **再次触摸:** 模式切换至"Gear 3"，摆动范围增大至±70°。
    *   **再次触摸:** 系统循环回到"Auto"模式，所有行为重新由温度决定。
*   **响应性测试:** 在舵机摆动的任何时刻，触摸传感器均能被**立即响应**，无任何延迟感，证明了非阻塞式架构的成功。

---

### **6. 讨论与分析 (Discussion & Analysis)**

本项目最大的技术挑战和收获在于从**阻塞式编程到非阻塞式编程**的思维转变。项目初期，使用`delay()`函数控制舵机速度的方案导致触摸传感器响应极其迟钝。通过独立测试排除了硬件故障后，问题被定位在软件架构上。引入`millis()`计时器，重构舵机控制和触摸检测函数，是项目成功的关键。

将温度采集和屏幕刷新等慢速任务进行低频调度，是对系统效率的进一步优化。这不仅降低了CPU的无效计算，也使得LCD显示更加稳定。

**项目局限性与未来改进:**

*   **控制算法:** 目前自动模式下的控制逻辑是简单的分级阈值判断。未来可引入更平滑的PID控制算法，实现舵机摆动幅度与温度的线性、精确对应。
*   **执行机构:** 目前使用舵机仅为模拟，未来可替换为直流风扇电机，通过PWM信号真正控制风速。
*   **扩展性:** 可增加湿度传感器（如DHT11），构建更全面的环境监控系统；或增加蓝牙/Wi-Fi模块，实现手机App远程控制和数据监控。

---

### **7. 结论 (Conclusion)**

本项目成功设计并实现了一个功能完善、交互性强的智能温控风扇系统。系统通过巧妙的软硬件结合，达到了预设的全部目标。在开发过程中，不仅巩固了对多种传感器和执行器使用的理解，更深入地掌握了嵌入式系统开发中的关键技术——非阻塞式编程和任务调度。该项目充分证明了即使使用基础的微控制器，通过优秀的软件设计，依然可以构建出高效、可靠且功能复杂的智能系统。

---

### **8. 附录 (Appendix)**